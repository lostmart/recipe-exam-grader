<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Dev Exam Grading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .score-pill { width: 50px; display: inline-block; text-align: center; }
        .test-pass { color: #198754; font-weight: bold; }
        .test-fail { color: #dc3545; font-weight: bold; }
        .bg-pass-soft { background-color: #e8f5e9; }
        .bg-fail-soft { background-color: #ffebee; }
    </style>
</head>
<body class="bg-light">

    <div class="container my-5">
        <div class="row mb-4">
            <div class="col-12 d-flex justify-content-between align-items-end">
                <h1>Exam Results</h1>
                <div id="last-updated" class="text-muted small"></div>
            </div>
        </div>

        <div class="row mb-4 g-3" id="stats-container">
            </div>
        
        <div class="card mb-4">
            <div class="card-body py-2">
                <input type="text" id="searchBar" class="form-control form-control-sm border-0" placeholder="Search student by name or ID...">
            </div>
        </div>

        <div class="accordion shadow-sm" id="resultsAccordion">
            <div class="text-center p-5" id="loader">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Processing JSON results...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        async function loadResults() {
            const accordionContainer = document.getElementById('resultsAccordion');
            const statsContainer = document.getElementById('stats-container');
            const updateLabel = document.getElementById('last-updated');

            try {
                const response = await fetch('./data.json');
                const data = await response.json();
                
                // 1. Display Stats
                updateLabel.innerText = `Generated: ${new Date(data.metadata.generatedAt).toLocaleString()}`;
                const s = data.statistics;
                statsContainer.innerHTML = `
                    <div class="col-md-3"><div class="card text-center p-2"><strong>Avg Score</strong><span class="fs-4 text-primary">${s.averageScore}%</span></div></div>
                    <div class="col-md-3"><div class="card text-center p-2"><strong>Passed</strong><span class="fs-4 text-success">${s.passedCount}</span></div></div>
                    <div class="col-md-3"><div class="card text-center p-2"><strong>Failed</strong><span class="fs-4 text-danger">${s.failedCount}</span></div></div>
                    <div class="col-md-3"><div class="card text-center p-2"><strong>Server Failures</strong><span class="fs-4 text-warning">${s.serverStartFailures}</span></div></div>
                `;

                // 2. Build Accordion
                accordionContainer.innerHTML = ''; 

                data.results.forEach((res, index) => {
                    const student = res.student;
                    const itemId = `item-${index}`;
                    const scoreClass = res.totalScore >= 50 ? 'bg-success' : 'bg-danger';
                    
                    // Create test rows
                    const testRows = res.tests.map(test => `
                        <tr class="${test.passed ? 'bg-pass-soft' : 'bg-fail-soft'}">
                            <td>${test.testName}</td>
                            <td class="${test.passed ? 'test-pass' : 'test-fail'}">${test.passed ? 'PASSED' : 'FAILED'}</td>
                            <td>${test.points} / ${test.maxPoints}</td>
                            <td class="small text-muted">${test.details || test.error || ''}</td>
                        </tr>
                    `).join('');

                    const accordionItem = `
                        <div class="accordion-item student-row" data-name="${student.studentName.toLowerCase()}" data-id="${student.studentId}">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${itemId}">
                                    <span class="badge ${scoreClass} score-pill me-3">${res.totalScore}</span>
                                    <div class="flex-grow-1">
                                        <strong>${student.studentName}</strong> 
                                        <span class="text-muted ms-2 small">#${student.studentId}</span>
                                    </div>
                                    ${!res.serverStarted ? '<span class="badge bg-warning text-dark me-3">Server Failed</span>' : ''}
                                </button>
                            </h2>
                            <div id="${itemId}" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                                <div class="accordion-body">
                                    <div class="d-flex gap-2 mb-3">
                                        <a href="${student.githubUrl}" target="_blank" class="btn btn-sm btn-dark">GitHub Repo</a>
                                        <div class="btn btn-sm btn-outline-secondary disabled">Path: ${student.repoPath}</div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-sm align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Test Description</th>
                                                    <th>Status</th>
                                                    <th>Points</th>
                                                    <th>Details</th>
                                                </tr>
                                            </thead>
                                            <tbody>${testRows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    accordionContainer.innerHTML += accordionItem;
                });

                // 3. Simple Search Logic
                document.getElementById('searchBar').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    document.querySelectorAll('.student-row').forEach(row => {
                        const match = row.getAttribute('data-name').includes(term) || row.getAttribute('data-id').includes(term);
                        row.style.display = match ? 'block' : 'none';
                    });
                });

            } catch (error) {
                accordionContainer.innerHTML = `<div class="alert alert-danger">Error loading JSON: ${error.message}</div>`;
            }
        }

        loadResults();
    </script>
</body>
</html>